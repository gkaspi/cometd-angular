org.cometd.CometD=function(name){var _cometd=this;var _name=name||"default";var _crossDomain=false;var _transports=new org.cometd.TransportRegistry();var _transport;var _status="disconnected";var _messageId=0;var _clientId=null;var _batch=0;var _messageQueue=[];var _internalBatch=false;var _listeners={};var _backoff=0;var _scheduledSend=null;var _extensions=[];var _advice={};var _handshakeProps;var _handshakeCallback;var _callbacks={};var _remoteCalls={};var _reestablish=false;var _connected=false;var _unconnectTime=0;var _config={protocol:null,stickyReconnect:true,connectTimeout:0,maxConnections:2,backoffIncrement:1000,maxBackoff:60000,logLevel:"info",reverseIncomingExtensions:true,maxNetworkDelay:10000,requestHeaders:{},appendMessageTypeToURL:true,autoBatch:false,urls:{},maxURILength:2000,advice:{timeout:60000,interval:0,reconnect:"retry",maxInterval:0}};function _fieldValue(object,name){try{return object[name]}catch(x){return undefined}}this._mixin=function(deep,target,objects){var result=target||{};for(var i=2;i<arguments.length;++i){var object=arguments[i];if(object===undefined||object===null){continue}for(var propName in object){if(object.hasOwnProperty(propName)){var prop=_fieldValue(object,propName);var targ=_fieldValue(result,propName);if(prop===target){continue}if(prop===undefined){continue}if(deep&&typeof prop==="object"&&prop!==null){if(prop instanceof Array){result[propName]=this._mixin(deep,targ instanceof Array?targ:[],prop)}else{var source=typeof targ==="object"&&!(targ instanceof Array)?targ:{};result[propName]=this._mixin(deep,source,prop)}}else{result[propName]=prop}}}}return result};function _isString(value){return org.cometd.Utils.isString(value)}function _isFunction(value){if(value===undefined||value===null){return false}return typeof value==="function"}function _zeroPad(value,length){var result="";while(--length>0){if(value>=Math.pow(10,length)){break}result+="0"}result+=value;return result}function _log(level,args){if(window.console){var logger=window.console[level];if(_isFunction(logger)){var now=new Date();[].splice.call(args,0,0,_zeroPad(now.getHours(),2)+":"+_zeroPad(now.getMinutes(),2)+":"+_zeroPad(now.getSeconds(),2)+"."+_zeroPad(now.getMilliseconds(),3));logger.apply(window.console,args)}}}this._warn=function(){_log("warn",arguments)};this._info=function(){if(_config.logLevel!=="warn"){_log("info",arguments)}};this._debug=function(){if(_config.logLevel==="debug"){_log("debug",arguments)}};function _splitURL(url){return/(^https?:\/\/)?(((\[[^\]]+\])|([^:\/\?#]+))(:(\d+))?)?([^\?#]*)(.*)?/.exec(url)}this._isCrossDomain=function(hostAndPort){return hostAndPort&&hostAndPort!==window.location.host};function _configure(configuration){_cometd._debug("Configuring cometd object with",configuration);if(_isString(configuration)){configuration={url:configuration}}if(!configuration){configuration={}}_config=_cometd._mixin(false,_config,configuration);var url=_cometd.getURL();if(!url){throw"Missing required configuration parameter 'url' specifying the Bayeux server URL"}var urlParts=_splitURL(url);var hostAndPort=urlParts[2];var uri=urlParts[8];var afterURI=urlParts[9];_crossDomain=_cometd._isCrossDomain(hostAndPort);if(_config.appendMessageTypeToURL){if(afterURI!==undefined&&afterURI.length>0){_cometd._info("Appending message type to URI "+uri+afterURI+" is not supported, disabling 'appendMessageTypeToURL' configuration");_config.appendMessageTypeToURL=false}else{var uriSegments=uri.split("/");var lastSegmentIndex=uriSegments.length-1;if(uri.match(/\/$/)){lastSegmentIndex-=1}if(uriSegments[lastSegmentIndex].indexOf(".")>=0){_cometd._info("Appending message type to URI "+uri+" is not supported, disabling 'appendMessageTypeToURL' configuration");_config.appendMessageTypeToURL=false}}}}function _removeListener(subscription){if(subscription){var subscriptions=_listeners[subscription.channel];if(subscriptions&&subscriptions[subscription.id]){delete subscriptions[subscription.id];_cometd._debug("Removed",subscription.listener?"listener":"subscription",subscription)}}}function _removeSubscription(subscription){if(subscription&&!subscription.listener){_removeListener(subscription)}}function _clearSubscriptions(){for(var channel in _listeners){if(_listeners.hasOwnProperty(channel)){var subscriptions=_listeners[channel];if(subscriptions){for(var i=0;i<subscriptions.length;++i){_removeSubscription(subscriptions[i])}}}}}function _setStatus(newStatus){if(_status!==newStatus){_cometd._debug("Status",_status,"->",newStatus);_status=newStatus}}function _isDisconnected(){return _status==="disconnecting"||_status==="disconnected"}function _nextMessageId(){var result=++_messageId;return""+result}function _applyExtension(scope,callback,name,message,outgoing){try{return callback.call(scope,message)}catch(x){var handler=_cometd.onExtensionException;if(_isFunction(handler)){_cometd._debug("Invoking extension exception handler",name,x);try{handler.call(_cometd,x,name,outgoing,message)}catch(xx){_cometd._info("Exception during execution of extension exception handler",name,xx)}}else{_cometd._info("Exception during execution of extension",name,x)}return message}}function _applyIncomingExtensions(message){for(var i=0;i<_extensions.length;++i){if(message===undefined||message===null){break}var index=_config.reverseIncomingExtensions?_extensions.length-1-i:i;var extension=_extensions[index];var callback=extension.extension.incoming;if(_isFunction(callback)){var result=_applyExtension(extension.extension,callback,extension.name,message,false);message=result===undefined?message:result}}return message}function _applyOutgoingExtensions(message){for(var i=0;i<_extensions.length;++i){if(message===undefined||message===null){break}var extension=_extensions[i];var callback=extension.extension.outgoing;if(_isFunction(callback)){var result=_applyExtension(extension.extension,callback,extension.name,message,true);message=result===undefined?message:result}}return message}function _notify(channel,message){var subscriptions=_listeners[channel];if(subscriptions&&subscriptions.length>0){for(var i=0;i<subscriptions.length;++i){var subscription=subscriptions[i];if(subscription){try{subscription.callback.call(subscription.scope,message)}catch(x){var handler=_cometd.onListenerException;if(_isFunction(handler)){_cometd._debug("Invoking listener exception handler",subscription,x);try{handler.call(_cometd,x,subscription,subscription.listener,message)}catch(xx){_cometd._info("Exception during execution of listener exception handler",subscription,xx)}}else{_cometd._info("Exception during execution of listener",subscription,message,x)}}}}}}function _notifyListeners(channel,message){_notify(channel,message);var channelParts=channel.split("/");var last=channelParts.length-1;for(var i=last;i>0;--i){var channelPart=channelParts.slice(0,i).join("/")+"/*";if(i===last){_notify(channelPart,message)}channelPart+="*";_notify(channelPart,message)}}function _cancelDelayedSend(){if(_scheduledSend!==null){org.cometd.Utils.clearTimeout(_scheduledSend)}_scheduledSend=null}function _delayedSend(operation,delay){_cancelDelayedSend();var time=_advice.interval+delay;_cometd._debug("Function scheduled in",time,"ms, interval =",_advice.interval,"backoff =",_backoff,operation);_scheduledSend=org.cometd.Utils.setTimeout(_cometd,operation,time)}var _handleMessages;var _handleFailure;function _send(sync,messages,metaConnect,extraPath){for(var i=0;i<messages.length;++i){var message=messages[i];var messageId=message.id;if(_clientId){message.clientId=_clientId}message=_applyOutgoingExtensions(message);if(message!==undefined&&message!==null){message.id=messageId;messages[i]=message}else{delete _callbacks[messageId];messages.splice(i--,1)}}if(messages.length===0){return}var url=_cometd.getURL();if(_config.appendMessageTypeToURL){if(!url.match(/\/$/)){url=url+"/"}if(extraPath){url=url+extraPath}}var envelope={url:url,sync:sync,messages:messages,onSuccess:function(rcvdMessages){try{_handleMessages.call(_cometd,rcvdMessages)}catch(x){_cometd._info("Exception during handling of messages",x)}},onFailure:function(conduit,messages,failure){try{var transport=_cometd.getTransport();failure.connectionType=transport?transport.getType():"unknown";_handleFailure.call(_cometd,conduit,messages,failure)}catch(x){_cometd._info("Exception during handling of failure",x)}}};_cometd._debug("Send",envelope);_transport.send(envelope,metaConnect)}function _queueSend(message){if(_batch>0||_internalBatch===true){_messageQueue.push(message)}else{_send(false,[message],false)}}this.send=_queueSend;function _resetBackoff(){_backoff=0}function _increaseBackoff(){if(_backoff<_config.maxBackoff){_backoff+=_config.backoffIncrement}return _backoff}function _startBatch(){++_batch;_cometd._debug("Starting batch, depth",_batch)}function _flushBatch(){var messages=_messageQueue;_messageQueue=[];if(messages.length>0){_send(false,messages,false)}}function _endBatch(){--_batch;_cometd._debug("Ending batch, depth",_batch);if(_batch<0){throw"Calls to startBatch() and endBatch() are not paired"}if(_batch===0&&!_isDisconnected()&&!_internalBatch){_flushBatch()}}function _connect(){if(!_isDisconnected()){var bayeuxMessage={id:_nextMessageId(),channel:"/meta/connect",connectionType:_transport.getType()};if(!_connected){bayeuxMessage.advice={timeout:0}}_setStatus("connecting");_cometd._debug("Connect sent",bayeuxMessage);_send(false,[bayeuxMessage],true,"connect");_setStatus("connected")}}function _delayedConnect(delay){_setStatus("connecting");_delayedSend(function(){_connect()},delay)}function _updateAdvice(newAdvice){if(newAdvice){_advice=_cometd._mixin(false,{},_config.advice,newAdvice);_cometd._debug("New advice",_advice)}}function _disconnect(abort){_cancelDelayedSend();if(abort&&_transport){_transport.abort()}_clientId=null;_setStatus("disconnected");_batch=0;_resetBackoff();_transport=null;if(_messageQueue.length>0){var messages=_messageQueue;_messageQueue=[];_handleFailure.call(_cometd,undefined,messages,{reason:"Disconnected"})}}function _notifyTransportException(oldTransport,newTransport,failure){var handler=_cometd.onTransportException;if(_isFunction(handler)){_cometd._debug("Invoking transport exception handler",oldTransport,newTransport,failure);try{handler.call(_cometd,failure,oldTransport,newTransport)}catch(x){_cometd._info("Exception during execution of transport exception handler",x)}}}function _handshake(handshakeProps,handshakeCallback){if(_isFunction(handshakeProps)){handshakeCallback=handshakeProps;handshakeProps=undefined}_clientId=null;_clearSubscriptions();if(_isDisconnected()){_transports.reset(true);_updateAdvice(_config.advice)}else{_updateAdvice(_cometd._mixin(false,_advice,{reconnect:"retry"}))}_batch=0;_internalBatch=true;_handshakeProps=handshakeProps;_handshakeCallback=handshakeCallback;var version="1.0";var url=_cometd.getURL();var transportTypes=_transports.findTransportTypes(version,_crossDomain,url);var bayeuxMessage={id:_nextMessageId(),version:version,minimumVersion:version,channel:"/meta/handshake",supportedConnectionTypes:transportTypes,advice:{timeout:_advice.timeout,interval:_advice.interval}};var message=_cometd._mixin(false,{},_handshakeProps,bayeuxMessage);_cometd._putCallback(message.id,handshakeCallback);if(!_transport){_transport=_transports.negotiateTransport(transportTypes,version,_crossDomain,url);if(!_transport){var failure="Could not find initial transport among: "+_transports.getTransportTypes();_cometd._warn(failure);throw failure}}_cometd._debug("Initial transport is",_transport.getType());_setStatus("handshaking");_cometd._debug("Handshake sent",message);_send(false,[message],false,"handshake")}function _delayedHandshake(delay){_setStatus("handshaking");_internalBatch=true;_delayedSend(function(){_handshake(_handshakeProps,_handshakeCallback)},delay)}function _notifyCallback(callback,message){try{callback.call(_cometd,message)}catch(x){var handler=_cometd.onCallbackException;if(_isFunction(handler)){_cometd._debug("Invoking callback exception handler",x);try{handler.call(_cometd,x,message)}catch(xx){_cometd._info("Exception during execution of callback exception handler",xx)}}else{_cometd._info("Exception during execution of message callback",x)}}}this._getCallback=function(messageId){return _callbacks[messageId]};this._putCallback=function(messageId,callback){var result=this._getCallback(messageId);if(_isFunction(callback)){_callbacks[messageId]=callback}return result};function _handleCallback(message){var callback=_cometd._getCallback([message.id]);if(_isFunction(callback)){delete _callbacks[message.id];_notifyCallback(callback,message)}}function _handleRemoteCall(message){var context=_remoteCalls[message.id];delete _remoteCalls[message.id];_cometd._debug("Handling remote call response for",message,"with context",context);if(context){var timeout=context.timeout;if(timeout){org.cometd.Utils.clearTimeout(timeout)}var callback=context.callback;if(_isFunction(callback)){_notifyCallback(callback,message);return true}}return false}this.onTransportFailure=function(message,failureInfo,actionFn){this._debug("Transport failure",failureInfo);var actionInfo={delay:this.getBackoffPeriod(),transport:this.getTransport()};var transports=this.getTransportRegistry();var url=this.getURL();var crossDomain=this._isCrossDomain(_splitURL(url)[2]);var version="1.0";var transportTypes=transports.findTransportTypes(version,crossDomain,url);var action=failureInfo.action;if(action==="disconnect"){if(message.channel==="/meta/handshake"){if(failureInfo.cause==="negotiation"){var failure="Could not negotiate transport, client=["+transportTypes+"], server=["+message.supportedConnectionTypes+"]";this._warn(failure);_notifyTransportException(_transport.getType(),null,{reason:failure,connectionType:_transport.getType(),transport:_transport});action="disconnect"}}}else{if(message.channel==="/meta/handshake"){if(!failureInfo.transport.valid){var newTransport=transports.negotiateTransport(transportTypes,version,crossDomain,url);if(!newTransport){this._warn("Could not negotiate transport, client=["+transportTypes+"]");_notifyTransportException(_transport.getType(),null,message.failure);action="disconnect"}else{this._debug("Transport",_transport.getType(),"->",newTransport.getType());_notifyTransportException(_transport.getType(),newTransport.getType(),message.failure);action="handshake";actionInfo.transport=newTransport}}}else{var now=new Date().getTime();if(_unconnectTime===0){_unconnectTime=now}var maxInterval=_advice.maxInterval;if(maxInterval>0){var expiration=_advice.timeout+_advice.interval+maxInterval;var unconnected=now-_unconnectTime;if(unconnected+_backoff>expiration){action="handshake"}}if(action==="handshake"){transports.reset(false);this.resetBackoffPeriod()}}}if(action!=="disconnect"){this.increaseBackoffPeriod()}actionInfo.action=action;actionFn.call(_cometd,actionInfo)};function _onTransportAction(actionInfo){_cometd._debug("Transport action",actionInfo);if(actionInfo.transport){_transport=actionInfo.transport}if(actionInfo.url){_transport.setURL(actionInfo.url)}var action=actionInfo.action;var delay=actionInfo.delay||0;switch(action){case"handshake":_delayedHandshake(delay);break;case"connect":_delayedConnect(delay);break;case"disconnect":_disconnect(true);break;default:throw"Unknown action "+action}}function _failHandshake(message,failureInfo){_handleCallback(message);_notifyListeners("/meta/handshake",message);_notifyListeners("/meta/unsuccessful",message);if(_isDisconnected()){failureInfo.action="disconnect"}_cometd.onTransportFailure.call(_cometd,message,failureInfo,_onTransportAction)}function _handshakeResponse(message){var url=_cometd.getURL();if(message.successful){var crossDomain=_cometd._isCrossDomain(_splitURL(url)[2]);var newTransport=_transports.negotiateTransport(message.supportedConnectionTypes,message.version,crossDomain,url);if(newTransport===null){message.successful=false;_failHandshake(message,{cause:"negotiation",action:"disconnect",transport:{type:_transport.getType(),url:url,valid:true}});return}else{if(_transport!==newTransport){_cometd._debug("Transport",_transport.getType(),"->",newTransport.getType());_transport=newTransport}}_clientId=message.clientId;_internalBatch=false;_flushBatch();message.reestablish=_reestablish;_reestablish=true;_handleCallback(message);_notifyListeners("/meta/handshake",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_resetBackoff();_delayedConnect(_backoff);break;case"none":_disconnect(true);break;default:throw"Unrecognized advice action "+action}}else{var failAction="handshake";if(_advice.reconnect==="none"){failAction="disconnect"}_failHandshake(message,{cause:"unsuccessful",action:failAction,transport:{type:_transport.getType(),url:url,valid:true}})}}function _handshakeFailure(message){var action="handshake";if(_advice.reconnect==="none"){action="disconnect"}_failHandshake(message,{cause:"failure",action:action,transport:{type:_transport.getType(),url:_cometd.getURL(),valid:false}})}function _failConnect(message,failureInfo){_notifyListeners("/meta/connect",message);_notifyListeners("/meta/unsuccessful",message);var action="connect";switch(_advice.reconnect){case"handshake":action="handshake";break;case"none":action="disconnect";break}if(_isDisconnected()){action="disconnect"}failureInfo.action=action;_cometd.onTransportFailure.call(_cometd,message,failureInfo,_onTransportAction)}function _connectResponse(message){_connected=message.successful;if(_connected){_notifyListeners("/meta/connect",message);var action=_isDisconnected()?"none":_advice.reconnect;switch(action){case"retry":_resetBackoff();_delayedConnect(_backoff);break;case"none":_disconnect(false);break;default:throw"Unrecognized advice action "+action}}else{_failConnect(message,{cause:"unsuccessful",transport:{type:_transport.getType(),url:_cometd.getURL(),valid:true}})}}function _connectFailure(message){_connected=false;_failConnect(message,{cause:"failure",transport:{type:_transport.getType(),url:_cometd.getURL(),valid:false}})}function _failDisconnect(message){_disconnect(true);_handleCallback(message);_notifyListeners("/meta/disconnect",message);_notifyListeners("/meta/unsuccessful",message)}function _disconnectResponse(message){if(message.successful){_disconnect(false);_handleCallback(message);_notifyListeners("/meta/disconnect",message)}else{_failDisconnect(message)}}function _disconnectFailure(message){_failDisconnect(message)}function _failSubscribe(message){var subscriptions=_listeners[message.subscription];if(subscriptions){for(var i=subscriptions.length-1;i>=0;--i){var subscription=subscriptions[i];if(subscription&&!subscription.listener){delete subscriptions[i];_cometd._debug("Removed failed subscription",subscription);break}}}_handleCallback(message);_notifyListeners("/meta/subscribe",message);_notifyListeners("/meta/unsuccessful",message)}function _subscribeResponse(message){if(message.successful){_handleCallback(message);_notifyListeners("/meta/subscribe",message)}else{_failSubscribe(message)}}function _subscribeFailure(message){_failSubscribe(message)}function _failUnsubscribe(message){_handleCallback(message);_notifyListeners("/meta/unsubscribe",message);_notifyListeners("/meta/unsuccessful",message)}function _unsubscribeResponse(message){if(message.successful){_handleCallback(message);_notifyListeners("/meta/unsubscribe",message)}else{_failUnsubscribe(message)}}function _unsubscribeFailure(message){_failUnsubscribe(message)}function _failMessage(message){if(!_handleRemoteCall(message)){_handleCallback(message);_notifyListeners("/meta/publish",message);_notifyListeners("/meta/unsuccessful",message)}}function _messageResponse(message){if(message.data!==undefined){if(!_handleRemoteCall(message)){_notifyListeners(message.channel,message)}}else{if(message.successful===undefined){_cometd._warn("Unknown Bayeux Message",message)}else{if(message.successful){_handleCallback(message);_notifyListeners("/meta/publish",message)}else{_failMessage(message)}}}}function _messageFailure(failure){_failMessage(failure)}function _receive(message){_unconnectTime=0;message=_applyIncomingExtensions(message);if(message===undefined||message===null){return}_updateAdvice(message.advice);var channel=message.channel;switch(channel){case"/meta/handshake":_handshakeResponse(message);break;case"/meta/connect":_connectResponse(message);break;case"/meta/disconnect":_disconnectResponse(message);break;case"/meta/subscribe":_subscribeResponse(message);break;case"/meta/unsubscribe":_unsubscribeResponse(message);break;default:_messageResponse(message);break}}this.receive=_receive;_handleMessages=function(rcvdMessages){_cometd._debug("Received",rcvdMessages);for(var i=0;i<rcvdMessages.length;++i){var message=rcvdMessages[i];_receive(message)}};_handleFailure=function(conduit,messages,failure){_cometd._debug("handleFailure",conduit,messages,failure);failure.transport=conduit;for(var i=0;i<messages.length;++i){var message=messages[i];var failureMessage={id:message.id,successful:false,channel:message.channel,failure:failure};failure.message=message;switch(message.channel){case"/meta/handshake":_handshakeFailure(failureMessage);break;case"/meta/connect":_connectFailure(failureMessage);break;case"/meta/disconnect":_disconnectFailure(failureMessage);break;case"/meta/subscribe":failureMessage.subscription=message.subscription;_subscribeFailure(failureMessage);break;case"/meta/unsubscribe":failureMessage.subscription=message.subscription;_unsubscribeFailure(failureMessage);break;default:_messageFailure(failureMessage);break}}};function _hasSubscriptions(channel){var subscriptions=_listeners[channel];if(subscriptions){for(var i=0;i<subscriptions.length;++i){if(subscriptions[i]){return true}}}return false}function _resolveScopedCallback(scope,callback){var delegate={scope:scope,method:callback};if(_isFunction(scope)){delegate.scope=undefined;delegate.method=scope}else{if(_isString(callback)){if(!scope){throw"Invalid scope "+scope}delegate.method=scope[callback];if(!_isFunction(delegate.method)){throw"Invalid callback "+callback+" for scope "+scope}}else{if(!_isFunction(callback)){throw"Invalid callback "+callback}}}return delegate}function _addListener(channel,scope,callback,isListener){var delegate=_resolveScopedCallback(scope,callback);_cometd._debug("Adding",isListener?"listener":"subscription","on",channel,"with scope",delegate.scope,"and callback",delegate.method);var subscription={channel:channel,scope:delegate.scope,callback:delegate.method,listener:isListener};var subscriptions=_listeners[channel];if(!subscriptions){subscriptions=[];_listeners[channel]=subscriptions}subscription.id=subscriptions.push(subscription)-1;_cometd._debug("Added",isListener?"listener":"subscription",subscription);subscription[0]=channel;subscription[1]=subscription.id;return subscription}this.registerTransport=function(type,transport,index){var result=_transports.add(type,transport,index);if(result){this._debug("Registered transport",type);if(_isFunction(transport.registered)){transport.registered(type,this)}}return result};this.unregisterTransport=function(type){var transport=_transports.remove(type);if(transport!==null){this._debug("Unregistered transport",type);if(_isFunction(transport.unregistered)){transport.unregistered()}}return transport};this.unregisterTransports=function(){_transports.clear()};this.getTransportTypes=function(){return _transports.getTransportTypes()};this.findTransport=function(name){return _transports.find(name)};this.getTransportRegistry=function(){return _transports};this.configure=function(configuration){_configure.call(this,configuration)};this.init=function(configuration,handshakeProps){this.configure(configuration);this.handshake(handshakeProps)};this.handshake=function(handshakeProps,handshakeCallback){_setStatus("disconnected");_reestablish=false;_handshake(handshakeProps,handshakeCallback)};this.disconnect=function(sync,disconnectProps,disconnectCallback){if(_isDisconnected()){return}if(typeof sync!=="boolean"){disconnectCallback=disconnectProps;disconnectProps=sync;sync=false}if(_isFunction(disconnectProps)){disconnectCallback=disconnectProps;disconnectProps=undefined}var bayeuxMessage={id:_nextMessageId(),channel:"/meta/disconnect"};var message=this._mixin(false,{},disconnectProps,bayeuxMessage);_cometd._putCallback(message.id,disconnectCallback);_setStatus("disconnecting");_send(sync===true,[message],false,"disconnect")};this.startBatch=function(){_startBatch()};this.endBatch=function(){_endBatch()};this.batch=function(scope,callback){var delegate=_resolveScopedCallback(scope,callback);this.startBatch();try{delegate.method.call(delegate.scope);this.endBatch()}catch(x){this._info("Exception during execution of batch",x);this.endBatch();throw x}};this.addListener=function(channel,scope,callback){if(arguments.length<2){throw"Illegal arguments number: required 2, got "+arguments.length}if(!_isString(channel)){throw"Illegal argument type: channel must be a string"}return _addListener(channel,scope,callback,true)};this.removeListener=function(subscription){if(!subscription||!subscription.channel||!("id" in subscription)){throw"Invalid argument: expected subscription, not "+subscription}_removeListener(subscription)};this.clearListeners=function(){_listeners={}};this.subscribe=function(channel,scope,callback,subscribeProps,subscribeCallback){if(arguments.length<2){throw"Illegal arguments number: required 2, got "+arguments.length}if(!_isString(channel)){throw"Illegal argument type: channel must be a string"}if(_isDisconnected()){throw"Illegal state: already disconnected"}if(_isFunction(scope)){subscribeCallback=subscribeProps;subscribeProps=callback;callback=scope;scope=undefined}if(_isFunction(subscribeProps)){subscribeCallback=subscribeProps;subscribeProps=undefined}var send=!_hasSubscriptions(channel);var subscription=_addListener(channel,scope,callback,false);if(send){var bayeuxMessage={id:_nextMessageId(),channel:"/meta/subscribe",subscription:channel};var message=this._mixin(false,{},subscribeProps,bayeuxMessage);_cometd._putCallback(message.id,subscribeCallback);_queueSend(message)}return subscription};this.unsubscribe=function(subscription,unsubscribeProps,unsubscribeCallback){if(arguments.length<1){throw"Illegal arguments number: required 1, got "+arguments.length}if(_isDisconnected()){throw"Illegal state: already disconnected"}if(_isFunction(unsubscribeProps)){unsubscribeCallback=unsubscribeProps;unsubscribeProps=undefined}this.removeListener(subscription);var channel=subscription.channel;if(!_hasSubscriptions(channel)){var bayeuxMessage={id:_nextMessageId(),channel:"/meta/unsubscribe",subscription:channel};var message=this._mixin(false,{},unsubscribeProps,bayeuxMessage);_cometd._putCallback(message.id,unsubscribeCallback);_queueSend(message)}};this.resubscribe=function(subscription,subscribeProps){_removeSubscription(subscription);if(subscription){return this.subscribe(subscription.channel,subscription.scope,subscription.callback,subscribeProps)}return undefined};this.clearSubscriptions=function(){_clearSubscriptions()};this.publish=function(channel,content,publishProps,publishCallback){if(arguments.length<1){throw"Illegal arguments number: required 1, got "+arguments.length}if(!_isString(channel)){throw"Illegal argument type: channel must be a string"}if(/^\/meta\//.test(channel)){throw"Illegal argument: cannot publish to meta channels"}if(_isDisconnected()){throw"Illegal state: already disconnected"}if(_isFunction(content)){publishCallback=content;content=publishProps={}}else{if(_isFunction(publishProps)){publishCallback=publishProps;publishProps={}}}var bayeuxMessage={id:_nextMessageId(),channel:channel,data:content};var message=this._mixin(false,{},publishProps,bayeuxMessage);_cometd._putCallback(message.id,publishCallback);_queueSend(message)};this.remoteCall=function(target,content,timeout,callback){if(arguments.length<1){throw"Illegal arguments number: required 1, got "+arguments.length}if(!_isString(target)){throw"Illegal argument type: target must be a string"}if(_isDisconnected()){throw"Illegal state: already disconnected"}if(_isFunction(content)){callback=content;content={};timeout=_config.maxNetworkDelay}else{if(_isFunction(timeout)){callback=timeout;timeout=_config.maxNetworkDelay}}if(typeof timeout!=="number"){throw"Illegal argument type: timeout must be a number"}if(!target.match(/^\//)){target="/"+target}var channel="/service"+target;var bayeuxMessage={id:_nextMessageId(),channel:channel,data:content};var context={callback:callback};if(timeout>0){context.timeout=org.cometd.Utils.setTimeout(_cometd,function(){_cometd._debug("Timing out remote call",bayeuxMessage,"after",timeout,"ms");_failMessage({id:bayeuxMessage.id,error:"406::timeout",successful:false,failure:{message:bayeuxMessage,reason:"Remote Call Timeout"}})},timeout);_cometd._debug("Scheduled remote call timeout",bayeuxMessage,"in",timeout,"ms")}_remoteCalls[bayeuxMessage.id]=context;_queueSend(bayeuxMessage)};this.getStatus=function(){return _status};this.isDisconnected=_isDisconnected;this.setBackoffIncrement=function(period){_config.backoffIncrement=period};this.getBackoffIncrement=function(){return _config.backoffIncrement};this.getBackoffPeriod=function(){return _backoff};this.increaseBackoffPeriod=function(){return _increaseBackoff()};this.resetBackoffPeriod=function(){_resetBackoff()};this.setLogLevel=function(level){_config.logLevel=level};this.registerExtension=function(name,extension){if(arguments.length<2){throw"Illegal arguments number: required 2, got "+arguments.length}if(!_isString(name)){throw"Illegal argument type: extension name must be a string"}var existing=false;for(var i=0;i<_extensions.length;++i){var existingExtension=_extensions[i];if(existingExtension.name===name){existing=true;break}}if(!existing){_extensions.push({name:name,extension:extension});this._debug("Registered extension",name);if(_isFunction(extension.registered)){extension.registered(name,this)}return true}else{this._info("Could not register extension with name",name,"since another extension with the same name already exists");return false}};this.unregisterExtension=function(name){if(!_isString(name)){throw"Illegal argument type: extension name must be a string"}var unregistered=false;for(var i=0;i<_extensions.length;++i){var extension=_extensions[i];if(extension.name===name){_extensions.splice(i,1);unregistered=true;this._debug("Unregistered extension",name);var ext=extension.extension;if(_isFunction(ext.unregistered)){ext.unregistered()}break}}return unregistered};this.getExtension=function(name){for(var i=0;i<_extensions.length;++i){var extension=_extensions[i];if(extension.name===name){return extension.extension}}return null};this.getName=function(){return _name};this.getClientId=function(){return _clientId};this.getURL=function(){if(_transport){var url=_transport.getURL();if(url){return url}url=_config.urls[_transport.getType()];if(url){return url}}return _config.url};this.getTransport=function(){return _transport};this.getConfiguration=function(){return this._mixin(true,{},_config)};this.getAdvice=function(){return this._mixin(true,{},_advice)}};